"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Redis = void 0;
const constructs_1 = require("constructs");
const ec2 = __importStar(require("aws-cdk-lib/aws-ec2"));
const elasticache = __importStar(require("aws-cdk-lib/aws-elasticache"));
const secretsmanager = __importStar(require("aws-cdk-lib/aws-secretsmanager"));
class Redis extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const { vpc, subnets, securityGroupsList, instanceType, dbIdentifier, primaryVpcCidrBlock } = props;
        this.vpc = vpc;
        this.id = id;
        this.securityGroupsList = securityGroupsList;
        this.primaryVpcCidrBlock = primaryVpcCidrBlock;
        this.dbIdentifier = dbIdentifier;
        this.instanceType = instanceType;
        this.subnets = subnets;
        this.initRedisCache();
    }
    initRedisCache() {
        const redisSecGroup = new ec2.SecurityGroup(this, this.id + 'redis-sg', {
            vpc: this.vpc
        });
        this.securityGroupsList.forEach((sg, index) => {
            redisSecGroup.addIngressRule(ec2.SecurityGroup.fromSecurityGroupId(this, `redis-cache-sg-${index}`, sg.securityGroupId), ec2.Port.tcp(6379));
        });
        if (this.primaryVpcCidrBlock !== undefined) {
            redisSecGroup.addIngressRule(ec2.Peer.ipv4(this.primaryVpcCidrBlock), ec2.Port.tcp(6379));
        }
        const cfnSubnetGroup = new elasticache.CfnSubnetGroup(this, 'redis-subnet-group', {
            subnetIds: this.subnets.map(sub => sub.subnetId),
            description: 'isolated subnet group'
        });
        this.elasticacheSecret = new secretsmanager.Secret(this, 'elasticache-secret', {
            generateSecretString: {
                includeSpace: false,
                excludeCharacters: '/"@%*()[]{}~|+?,\'\\_=`;:'
            }
        });
        this.replicationGroup = new elasticache.CfnReplicationGroup(this, 'redis-cluster', {
            replicationGroupId: this.dbIdentifier,
            replicationGroupDescription: 'redis cluster',
            atRestEncryptionEnabled: true,
            cacheNodeType: this.instanceType ?? 'cache.t4g.micro',
            engine: 'redis',
            transitEncryptionEnabled: true,
            // this is an unsafe unwrap of the secret value which may be exposed
            authToken: this.elasticacheSecret.secretValue.unsafeUnwrap(),
            multiAzEnabled: true,
            numNodeGroups: 1,
            replicasPerNodeGroup: 1,
            port: 6379,
            autoMinorVersionUpgrade: true,
            cacheSubnetGroupName: cfnSubnetGroup.ref,
            securityGroupIds: [redisSecGroup.securityGroupId]
        });
    }
    get redisEndpoint() {
        return this.replicationGroup.attrPrimaryEndPointAddress;
    }
    get redisPort() {
        return this.replicationGroup.attrPrimaryEndPointPort;
    }
    get redisAuthTokenSecretArn() {
        return this.elasticacheSecret.secretArn;
    }
}
exports.Redis = Redis;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkaXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29uc3RydWN0cy9kYi9yZWRpcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2Qyx5REFBMkM7QUFDM0MseUVBQTJEO0FBQzNELCtFQUFpRTtBQVdqRSxNQUFhLEtBQU0sU0FBUSxzQkFBUztJQVdsQyxZQUFvQixLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUN0RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2pCLE1BQU0sRUFDSixHQUFHLEVBQ0gsT0FBTyxFQUNQLGtCQUFrQixFQUNsQixZQUFZLEVBQ1osWUFBWSxFQUNaLG1CQUFtQixFQUNwQixHQUFHLEtBQUssQ0FBQztRQUNWLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDYixJQUFJLENBQUMsa0JBQWtCLEdBQUcsa0JBQWtCLENBQUM7UUFDN0MsSUFBSSxDQUFDLG1CQUFtQixHQUFHLG1CQUFtQixDQUFDO1FBQy9DLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRU0sY0FBYztRQUNuQixNQUFNLGFBQWEsR0FBRyxJQUFJLEdBQUcsQ0FBQyxhQUFhLENBQ3pDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxHQUFHLFVBQVUsRUFBRTtZQUMxQixHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUc7U0FDZCxDQUFDLENBQUM7UUFFTCxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBc0IsRUFBRSxLQUFhLEVBQUUsRUFBRTtZQUN4RSxhQUFhLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLGtCQUFrQixLQUFLLEVBQUUsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMvSSxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksSUFBSSxDQUFDLG1CQUFtQixLQUFLLFNBQVMsRUFBRTtZQUMxQyxhQUFhLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDM0Y7UUFFRCxNQUFNLGNBQWMsR0FBRyxJQUFJLFdBQVcsQ0FBQyxjQUFjLENBQ25ELElBQUksRUFDSixvQkFBb0IsRUFDcEI7WUFDRSxTQUFTLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO1lBQ2hELFdBQVcsRUFBRSx1QkFBdUI7U0FDckMsQ0FDRixDQUFDO1FBRUYsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksY0FBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsb0JBQW9CLEVBQUU7WUFDN0Usb0JBQW9CLEVBQUU7Z0JBQ3BCLFlBQVksRUFBRSxLQUFLO2dCQUNuQixpQkFBaUIsRUFBRSwyQkFBMkI7YUFDL0M7U0FDRixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxXQUFXLENBQUMsbUJBQW1CLENBQ3pELElBQUksRUFDSixlQUFlLEVBQ2Y7WUFDRSxrQkFBa0IsRUFBRSxJQUFJLENBQUMsWUFBWTtZQUNyQywyQkFBMkIsRUFBRSxlQUFlO1lBQzVDLHVCQUF1QixFQUFFLElBQUk7WUFDN0IsYUFBYSxFQUFFLElBQUksQ0FBQyxZQUFZLElBQUksaUJBQWlCO1lBQ3JELE1BQU0sRUFBRSxPQUFPO1lBQ2Ysd0JBQXdCLEVBQUUsSUFBSTtZQUM5QixvRUFBb0U7WUFDcEUsU0FBUyxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFO1lBQzVELGNBQWMsRUFBRSxJQUFJO1lBQ3BCLGFBQWEsRUFBRSxDQUFDO1lBQ2hCLG9CQUFvQixFQUFFLENBQUM7WUFDdkIsSUFBSSxFQUFFLElBQUk7WUFDVix1QkFBdUIsRUFBRSxJQUFJO1lBQzdCLG9CQUFvQixFQUFFLGNBQWMsQ0FBQyxHQUFHO1lBQ3hDLGdCQUFnQixFQUFFLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQztTQUNsRCxDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsSUFBVyxhQUFhO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLDBCQUEwQixDQUFDO0lBQzFELENBQUM7SUFFRCxJQUFXLFNBQVM7UUFDbEIsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsdUJBQXVCLENBQUM7SUFDdkQsQ0FBQztJQUVELElBQVcsdUJBQXVCO1FBQ2hDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQztJQUMxQyxDQUFDO0NBQ0Y7QUE5RkQsc0JBOEZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnYXdzLWNkay1saWIvYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBlbGFzdGljYWNoZSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWxhc3RpY2FjaGUnO1xuaW1wb3J0ICogYXMgc2VjcmV0c21hbmFnZXIgZnJvbSAnYXdzLWNkay1saWIvYXdzLXNlY3JldHNtYW5hZ2VyJztcblxuZXhwb3J0IGludGVyZmFjZSBSZWRpc0NhY2hlUHJvcHMge1xuICB2cGM6IGVjMi5JVnBjO1xuICBzdWJuZXRzOiBlYzIuSVN1Ym5ldFtdO1xuICBzZWN1cml0eUdyb3Vwc0xpc3Q6IGVjMi5JU2VjdXJpdHlHcm91cFtdO1xuICBpbnN0YW5jZVR5cGU/OiBzdHJpbmc7XG4gIGRiSWRlbnRpZmllcjogc3RyaW5nO1xuICBwcmltYXJ5VnBjQ2lkckJsb2NrPzogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgUmVkaXMgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICBwcml2YXRlIHJlYWRvbmx5IHZwYzogZWMyLklWcGM7XG4gIHByaXZhdGUgcmVhZG9ubHkgaWQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgc2VjdXJpdHlHcm91cHNMaXN0OiBlYzIuSVNlY3VyaXR5R3JvdXBbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBwcmltYXJ5VnBjQ2lkckJsb2NrOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3VibmV0czogZWMyLklTdWJuZXRbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBkYklkZW50aWZpZXI6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBpbnN0YW5jZVR5cGU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSByZXBsaWNhdGlvbkdyb3VwOiBlbGFzdGljYWNoZS5DZm5SZXBsaWNhdGlvbkdyb3VwO1xuICBwcml2YXRlIGVsYXN0aWNhY2hlU2VjcmV0OiBzZWNyZXRzbWFuYWdlci5TZWNyZXQ7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yIChzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogUmVkaXNDYWNoZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcbiAgICBjb25zdCB7XG4gICAgICB2cGMsXG4gICAgICBzdWJuZXRzLFxuICAgICAgc2VjdXJpdHlHcm91cHNMaXN0LFxuICAgICAgaW5zdGFuY2VUeXBlLFxuICAgICAgZGJJZGVudGlmaWVyLFxuICAgICAgcHJpbWFyeVZwY0NpZHJCbG9ja1xuICAgIH0gPSBwcm9wcztcbiAgICB0aGlzLnZwYyA9IHZwYztcbiAgICB0aGlzLmlkID0gaWQ7XG4gICAgdGhpcy5zZWN1cml0eUdyb3Vwc0xpc3QgPSBzZWN1cml0eUdyb3Vwc0xpc3Q7XG4gICAgdGhpcy5wcmltYXJ5VnBjQ2lkckJsb2NrID0gcHJpbWFyeVZwY0NpZHJCbG9jaztcbiAgICB0aGlzLmRiSWRlbnRpZmllciA9IGRiSWRlbnRpZmllcjtcbiAgICB0aGlzLmluc3RhbmNlVHlwZSA9IGluc3RhbmNlVHlwZTtcbiAgICB0aGlzLnN1Ym5ldHMgPSBzdWJuZXRzO1xuICAgIHRoaXMuaW5pdFJlZGlzQ2FjaGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBpbml0UmVkaXNDYWNoZSAoKTogdm9pZCB7XG4gICAgY29uc3QgcmVkaXNTZWNHcm91cCA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cChcbiAgICAgIHRoaXMsIHRoaXMuaWQgKyAncmVkaXMtc2cnLCB7XG4gICAgICAgIHZwYzogdGhpcy52cGNcbiAgICAgIH0pO1xuXG4gICAgdGhpcy5zZWN1cml0eUdyb3Vwc0xpc3QuZm9yRWFjaCgoc2c6IGVjMi5JU2VjdXJpdHlHcm91cCwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgcmVkaXNTZWNHcm91cC5hZGRJbmdyZXNzUnVsZShlYzIuU2VjdXJpdHlHcm91cC5mcm9tU2VjdXJpdHlHcm91cElkKHRoaXMsIGByZWRpcy1jYWNoZS1zZy0ke2luZGV4fWAsIHNnLnNlY3VyaXR5R3JvdXBJZCksIGVjMi5Qb3J0LnRjcCg2Mzc5KSk7XG4gICAgfSk7XG4gICAgaWYgKHRoaXMucHJpbWFyeVZwY0NpZHJCbG9jayAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZWRpc1NlY0dyb3VwLmFkZEluZ3Jlc3NSdWxlKGVjMi5QZWVyLmlwdjQodGhpcy5wcmltYXJ5VnBjQ2lkckJsb2NrKSwgZWMyLlBvcnQudGNwKDYzNzkpKTtcbiAgICB9XG5cbiAgICBjb25zdCBjZm5TdWJuZXRHcm91cCA9IG5ldyBlbGFzdGljYWNoZS5DZm5TdWJuZXRHcm91cChcbiAgICAgIHRoaXMsXG4gICAgICAncmVkaXMtc3VibmV0LWdyb3VwJyxcbiAgICAgIHtcbiAgICAgICAgc3VibmV0SWRzOiB0aGlzLnN1Ym5ldHMubWFwKHN1YiA9PiBzdWIuc3VibmV0SWQpLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ2lzb2xhdGVkIHN1Ym5ldCBncm91cCdcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5lbGFzdGljYWNoZVNlY3JldCA9IG5ldyBzZWNyZXRzbWFuYWdlci5TZWNyZXQodGhpcywgJ2VsYXN0aWNhY2hlLXNlY3JldCcsIHtcbiAgICAgIGdlbmVyYXRlU2VjcmV0U3RyaW5nOiB7XG4gICAgICAgIGluY2x1ZGVTcGFjZTogZmFsc2UsXG4gICAgICAgIGV4Y2x1ZGVDaGFyYWN0ZXJzOiAnL1wiQCUqKClbXXt9fnwrPyxcXCdcXFxcXz1gOzonXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLnJlcGxpY2F0aW9uR3JvdXAgPSBuZXcgZWxhc3RpY2FjaGUuQ2ZuUmVwbGljYXRpb25Hcm91cChcbiAgICAgIHRoaXMsXG4gICAgICAncmVkaXMtY2x1c3RlcicsXG4gICAgICB7XG4gICAgICAgIHJlcGxpY2F0aW9uR3JvdXBJZDogdGhpcy5kYklkZW50aWZpZXIsXG4gICAgICAgIHJlcGxpY2F0aW9uR3JvdXBEZXNjcmlwdGlvbjogJ3JlZGlzIGNsdXN0ZXInLFxuICAgICAgICBhdFJlc3RFbmNyeXB0aW9uRW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgY2FjaGVOb2RlVHlwZTogdGhpcy5pbnN0YW5jZVR5cGUgPz8gJ2NhY2hlLnQ0Zy5taWNybycsXG4gICAgICAgIGVuZ2luZTogJ3JlZGlzJyxcbiAgICAgICAgdHJhbnNpdEVuY3J5cHRpb25FbmFibGVkOiB0cnVlLFxuICAgICAgICAvLyB0aGlzIGlzIGFuIHVuc2FmZSB1bndyYXAgb2YgdGhlIHNlY3JldCB2YWx1ZSB3aGljaCBtYXkgYmUgZXhwb3NlZFxuICAgICAgICBhdXRoVG9rZW46IHRoaXMuZWxhc3RpY2FjaGVTZWNyZXQuc2VjcmV0VmFsdWUudW5zYWZlVW53cmFwKCksXG4gICAgICAgIG11bHRpQXpFbmFibGVkOiB0cnVlLFxuICAgICAgICBudW1Ob2RlR3JvdXBzOiAxLFxuICAgICAgICByZXBsaWNhc1Blck5vZGVHcm91cDogMSxcbiAgICAgICAgcG9ydDogNjM3OSxcbiAgICAgICAgYXV0b01pbm9yVmVyc2lvblVwZ3JhZGU6IHRydWUsXG4gICAgICAgIGNhY2hlU3VibmV0R3JvdXBOYW1lOiBjZm5TdWJuZXRHcm91cC5yZWYsXG4gICAgICAgIHNlY3VyaXR5R3JvdXBJZHM6IFtyZWRpc1NlY0dyb3VwLnNlY3VyaXR5R3JvdXBJZF1cbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcHVibGljIGdldCByZWRpc0VuZHBvaW50ICgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnJlcGxpY2F0aW9uR3JvdXAuYXR0clByaW1hcnlFbmRQb2ludEFkZHJlc3M7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHJlZGlzUG9ydCAoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5yZXBsaWNhdGlvbkdyb3VwLmF0dHJQcmltYXJ5RW5kUG9pbnRQb3J0O1xuICB9XG5cbiAgcHVibGljIGdldCByZWRpc0F1dGhUb2tlblNlY3JldEFybiAoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5lbGFzdGljYWNoZVNlY3JldC5zZWNyZXRBcm47XG4gIH1cbn0iXX0=