"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.EKS = void 0;
const constructs_1 = require("constructs");
const eks = __importStar(require("aws-cdk-lib/aws-eks"));
const ec2 = __importStar(require("aws-cdk-lib/aws-ec2"));
const iam = __importStar(require("aws-cdk-lib/aws-iam"));
const cdk = __importStar(require("aws-cdk-lib"));
const ssm = __importStar(require("aws-cdk-lib/aws-ssm"));
const tagging_1 = require("../networking/tagging");
const iac_utils_1 = require("@tinystacks/iac-utils");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const eks_cleanup_1 = require("./eks-cleanup");
class EKS extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const { vpc, internetAccess, defaultCapacity = 0, minimumCapacity, maximumCapacity, instanceType = new ec2.InstanceType('t3.micro'), clusterName = `c-${new Date().getTime()}` } = props;
        this.id = id;
        this._vpc = vpc;
        this._internetAccess = internetAccess;
        this._defaultCapacity = defaultCapacity;
        this._minimumCapacity = minimumCapacity;
        this._maximumCapacity = maximumCapacity;
        this._instanceType = instanceType;
        this._clusterName = clusterName;
        const { cluster, mastersRole } = this.createCluster();
        this._cluster = cluster;
        this._mastersRole = mastersRole;
        this.configureLoadBalancerController();
        const cleanup = new eks_cleanup_1.EksCleanup(this, (0, iac_utils_1.constructId)('EksCleanup'), {
            vpcId: this.vpc.vpcId,
            clusterName
        });
        this.cluster.node.addDependency(cleanup);
        this.tagSubnets();
        this.createOutputs();
        this._clusterNameSsmParamName = `${id}-clusterName`;
        //store clustername in ssm
        new ssm.StringParameter(this, `${id}-clusterName-ssm`, {
            parameterName: this._clusterNameSsmParamName,
            stringValue: this._cluster.clusterName
        });
    }
    createCluster() {
        let nodeSubnetType;
        if (this.internetAccess) {
            nodeSubnetType = ec2.SubnetType.PRIVATE_WITH_NAT;
        }
        else {
            nodeSubnetType = ec2.SubnetType.PUBLIC;
        }
        const mastersRole = new iam.Role(this, (0, iac_utils_1.constructId)('masters', 'role'), {
            assumedBy: new iam.AccountPrincipal(cdk.Stack.of(this).account)
        });
        const cluster = new eks.Cluster(this, (0, iac_utils_1.constructId)('eks', 'cluster'), {
            clusterName: this.clusterName,
            version: eks.KubernetesVersion.V1_21,
            vpc: this.vpc,
            defaultCapacity: 0,
            mastersRole
        });
        mastersRole.attachInlinePolicy(new iam.Policy(this, (0, iac_utils_1.constructId)('kubectl', 'policy'), {
            statements: [
                new iam.PolicyStatement({
                    actions: ['kubectl:*'],
                    resources: [cluster.clusterArn]
                })
            ]
        }));
        cluster.addAutoScalingGroupCapacity((0, iac_utils_1.constructId)('eks', 'asg', 'capacity'), {
            instanceType: this.instanceType,
            minCapacity: this.minimumCapacity,
            maxCapacity: this.maximumCapacity,
            vpcSubnets: {
                subnetType: nodeSubnetType
            }
        });
        return { cluster, mastersRole };
    }
    configureLoadBalancerController() {
        new eks.AlbController(this, 'AlbController', {
            cluster: this._cluster,
            version: eks.AlbControllerVersion.V2_4_1
        });
    }
    createOutputs() {
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('cluster', 'name'), {
            description: `${this.id}-cluster-name`,
            value: this.cluster.clusterName
        });
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('cluster', 'arn'), {
            description: `${this.id}-cluster-arn`,
            value: this.cluster.clusterArn
        });
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('cluster', 'role', 'name'), {
            description: `${this.id}-cluster-role-name`,
            value: this.cluster.role.roleName
        });
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('cluster', 'role', 'arn'), {
            description: `${this.id}-cluster-role-arn`,
            value: this.cluster.role.roleArn
        });
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('cluster', 'admin', 'role', 'name'), {
            description: `${this.id}-cluster-admin-role-name`,
            value: this.cluster.adminRole.roleName
        });
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('cluster', 'admin', 'role', 'arn'), {
            description: `${this.id}-cluster-admin-role-arn`,
            value: this.cluster.adminRole.roleArn
        });
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('cluster', 'kubectl', 'role', 'name'), {
            description: `${this.id}-cluster-kubectl-role-name`,
            value: this.cluster.kubectlRole?.roleName || ''
        });
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('cluster', 'kubectl', 'role', 'arn'), {
            description: `${this.id}-cluster-kubectl-role-arn`,
            value: this.cluster.kubectlRole?.roleArn || ''
        });
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('cluster', 'masters', 'role', 'name'), {
            description: `${this.id}-cluster-masters-role-name`,
            value: this.mastersRole.roleName
        });
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('cluster', 'masters', 'role', 'arn'), {
            description: `${this.id}-cluster-masters-role-arn`,
            value: this.mastersRole.roleArn
        });
        // new CfnOutput(this, constructId('eks', 'cluster', 'service', 'account', 'role', 'name'), {
        //   description: `${this.id}-eks-cluster-service-account-role-name`,
        //   value: this.serviceAccount.role.roleName
        // });
        // new CfnOutput(this, constructId('eks', 'cluster', 'service', 'account', 'role', 'arn'), {
        //   description: `${this.id}-eks-cluster-service-account-role-arn`,
        //   value: this.serviceAccount.role.roleArn
        // });
    }
    createTagParams(resources, key, value) {
        const params = {
            Resources: resources,
            Tags: [
                {
                    Key: key,
                    Value: value
                }
            ]
        };
        return params;
    }
    tagSubnets() {
        const publicSubnets = [];
        const privateSubnets = [];
        for (const subnet of this._vpc.publicSubnets) {
            publicSubnets.push(subnet.subnetId);
        }
        for (const subnet of this._vpc.privateSubnets) {
            privateSubnets.push(subnet.subnetId);
        }
        const publicTagRequestParams = this.createTagParams(publicSubnets, 'kubernetes.io/role/elb', '1');
        const privateTagRequestParams = this.createTagParams(publicSubnets, 'kubernetes.io/role/internal-elb', '1');
        new tagging_1.SubnetTagging(this, 'tagPublicSubnets', { ec2ResourceTagsRequest: publicTagRequestParams });
        new tagging_1.SubnetTagging(this, 'tagPrivateSubnets', { ec2ResourceTagsRequest: privateTagRequestParams });
    }
    get cluster() {
        return this._cluster;
    }
    get mastersRole() {
        return this._mastersRole;
    }
    get vpc() {
        return this._vpc;
    }
    get internetAccess() {
        return this._internetAccess;
    }
    get defaultCapacity() {
        return this._defaultCapacity;
    }
    get minimumCapacity() {
        return this._minimumCapacity;
    }
    get maximumCapacity() {
        return this._maximumCapacity;
    }
    get instanceType() {
        return this._instanceType;
    }
    get serviceAccount() {
        return this._serviceAccount;
    }
    get clusterName() {
        return this._clusterName;
    }
    get clusterNameParameterName() {
        return this._clusterNameSsmParamName;
    }
}
exports.EKS = EKS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWtzLWNsdXN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29uc3RydWN0cy9jb21wdXRlL2Vrcy1jbHVzdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXVDO0FBQ3ZDLHlEQUEyQztBQUMzQyx5REFBMkM7QUFDM0MseURBQTJDO0FBQzNDLGlEQUFtQztBQUNuQyx5REFBMkM7QUFDM0MsbURBQXNEO0FBQ3RELHFEQUFvRDtBQUNwRCw2Q0FBd0M7QUFFeEMsK0NBQTJDO0FBWTNDLE1BQWEsR0FBSSxTQUFRLHNCQUFTO0lBY2hDLFlBQWEsS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBZTtRQUN4RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sRUFDSixHQUFHLEVBQ0gsY0FBYyxFQUNkLGVBQWUsR0FBRyxDQUFDLEVBQ25CLGVBQWUsRUFDZixlQUFlLEVBQ2YsWUFBWSxHQUFHLElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsRUFDL0MsV0FBVyxHQUFHLEtBQUssSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxFQUMxQyxHQUFHLEtBQUssQ0FBQztRQUVWLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUM7UUFDaEIsSUFBSSxDQUFDLGVBQWUsR0FBRyxjQUFjLENBQUM7UUFDdEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGVBQWUsQ0FBQztRQUN4QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZUFBZSxDQUFDO1FBQ3hDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxlQUFlLENBQUM7UUFDeEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxZQUFZLENBQUM7UUFDbEMsSUFBSSxDQUFDLFlBQVksR0FBRyxXQUFXLENBQUM7UUFDaEMsTUFBTSxF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VztRQUNwQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDM0IsQ0FBQztJQUNELElBQVcsd0JBQXdCO1FBQ2pDLE9BQU8sSUFBSSxDQUFDLHdCQUF3QixDQUFDO0lBQ3ZDLENBQUM7Q0FDRjtBQXZPRCxrQkF1T0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCAqIGFzIGVrcyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWtzJztcbmltcG9ydCAqIGFzIGVjMiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCAqIGFzIGlhbSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBzc20gZnJvbSAnYXdzLWNkay1saWIvYXdzLXNzbSc7XG5pbXBvcnQgeyBTdWJuZXRUYWdnaW5nIH0gZnJvbSAnLi4vbmV0d29ya2luZy90YWdnaW5nJztcbmltcG9ydCB7IGNvbnN0cnVjdElkIH0gZnJvbSAnQHRpbnlzdGFja3MvaWFjLXV0aWxzJztcbmltcG9ydCB7IENmbk91dHB1dCB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IEluc3RhbmNlVHlwZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInO1xuaW1wb3J0IHsgRWtzQ2xlYW51cCB9IGZyb20gJy4vZWtzLWNsZWFudXAnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEVrc1Byb3BzIHtcbiAgdnBjOiBlYzIuSVZwYztcbiAgaW50ZXJuZXRBY2Nlc3M6IGJvb2xlYW47XG4gIGRlZmF1bHRDYXBhY2l0eT86IG51bWJlcjtcbiAgbWluaW11bUNhcGFjaXR5PzogbnVtYmVyO1xuICBtYXhpbXVtQ2FwYWNpdHk/OiBudW1iZXI7XG4gIGluc3RhbmNlVHlwZT86IEluc3RhbmNlVHlwZTtcbiAgY2x1c3Rlck5hbWU/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBFS1MgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICBpZDogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IF92cGM6IGVjMi5JVnBjO1xuICBwcml2YXRlIHJlYWRvbmx5IF9pbnRlcm5ldEFjY2VzczogYm9vbGVhbjtcbiAgcHJpdmF0ZSByZWFkb25seSBfZGVmYXVsdENhcGFjaXR5OiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgX21pbmltdW1DYXBhY2l0eTogbnVtYmVyIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIHJlYWRvbmx5IF9tYXhpbXVtQ2FwYWNpdHk6IG51bWJlciB8IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSByZWFkb25seSBfaW5zdGFuY2VUeXBlOiBJbnN0YW5jZVR5cGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgX2NsdXN0ZXI6IGVrcy5DbHVzdGVyO1xuICBwcml2YXRlIHJlYWRvbmx5IF9tYXN0ZXJzUm9sZTogaWFtLlJvbGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgX3NlcnZpY2VBY2NvdW50OiBla3MuU2VydmljZUFjY291bnQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgX2NsdXN0ZXJOYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgX2NsdXN0ZXJOYW1lU3NtUGFyYW1OYW1lOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IgKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBFa3NQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCB7XG4gICAgICB2cGMsXG4gICAgICBpbnRlcm5ldEFjY2VzcyxcbiAgICAgIGRlZmF1bHRDYXBhY2l0eSA9IDAsXG4gICAgICBtaW5pbXVtQ2FwYWNpdHksXG4gICAgICBtYXhpbXVtQ2FwYWNpdHksXG4gICAgICBpbnN0YW5jZVR5cGUgPSBuZXcgZWMyLkluc3RhbmNlVHlwZSgndDMubWljcm8nKSxcbiAgICAgIGNsdXN0ZXJOYW1lID0gYGMtJHtuZXcgRGF0ZSgpLmdldFRpbWUoKX1gXG4gICAgfSA9IHByb3BzO1xuXG4gICAgdGhpcy5pZCA9IGlkO1xuICAgIHRoaXMuX3ZwYyA9IHZwYztcbiAgICB0aGlzLl9pbnRlcm5ldEFjY2VzcyA9IGludGVybmV0QWNjZXNzO1xuICAgIHRoaXMuX2RlZmF1bHRDYXBhY2l0eSA9IGRlZmF1bHRDYXBhY2l0eTtcbiAgICB0aGlzLl9taW5pbXVtQ2FwYWNpdHkgPSBtaW5pbXVtQ2FwYWNpdHk7XG4gICAgdGhpcy5fbWF4aW11bUNhcGFjaXR5ID0gbWF4aW11bUNhcGFjaXR5O1xuICAgIHRoaXMuX2luc3RhbmNlVHlwZSA9IGluc3RhbmNlVHlwZTtcbiAgICB0aGlzLl9jbHVzdGVyTmFtZSA9IGNsdXN0ZXJOYW1lO1xuICAgIGNvbnN0IHtcbiAgICAgIGNsdXN0ZXIsXG4gICAgICBtYXN0ZXJzUm9sZVxuICAgIH0gPSB0aGlzLmNyZWF0ZUNsdXN0ZXIoKTtcblxuICAgIHRoaXMuX2NsdXN0ZXIgPSBjbHVzdGVyO1xuICAgIHRoaXMuX21hc3RlcnNSb2xlID0gbWFzdGVyc1JvbGU7XG4gICAgdGhpcy5jb25maWd1cmVMb2FkQmFsYW5jZXJDb250cm9sbGVyKCk7XG4gICAgY29uc3QgY2xlYW51cCA9IG5ldyBFa3NDbGVhbnVwKHRoaXMsIGNvbnN0cnVjdElkKCdFa3NDbGVhbnVwJyksIHtcbiAgICAgIHZwY0lkOiB0aGlzLnZwYy52cGNJZCxcbiAgICAgIGNsdXN0ZXJOYW1lXG4gICAgfSk7XG4gICAgdGhpcy5jbHVzdGVyLm5vZGUuYWRkRGVwZW5kZW5jeShjbGVhbnVwKTtcbiAgICB0aGlzLnRhZ1N1Ym5ldHMoKTtcbiAgICB0aGlzLmNyZWF0ZU91dHB1dHMoKTtcbiAgICB0aGlzLl9jbHVzdGVyTmFtZVNzbVBhcmFtTmFtZSA9IGAke2lkfS1jbHVzdGVyTmFtZWA7XG4gICAgLy9zdG9yZSBjbHVzdGVybmFtZSBpbiBzc21cbiAgICBuZXcgc3NtLlN0cmluZ1BhcmFtZXRlcih0aGlzLCBgJHtpZH0tY2x1c3Rlck5hbWUtc3NtYCwge1xuICAgICAgcGFyYW1ldGVyTmFtZTogdGhpcy5fY2x1c3Rlck5hbWVTc21QYXJhbU5hbWUsXG4gICAgICBzdHJpbmdWYWx1ZTogdGhpcy5fY2x1c3Rlci5jbHVzdGVyTmFtZVxuICAgIH0pO1xuICAgIFxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDbHVzdGVyICgpOiB7XG4gICAgY2x1c3RlcjogZWtzLkNsdXN0ZXJcbiAgICBtYXN0ZXJzUm9sZTogaWFtLlJvbGVcbiAgICB9IHtcbiAgICBsZXQgbm9kZVN1Ym5ldFR5cGU7XG4gICAgaWYgKHRoaXMuaW50ZXJuZXRBY2Nlc3MpIHtcbiAgICAgIG5vZGVTdWJuZXRUeXBlID0gZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9XSVRIX05BVDtcbiAgICB9IGVsc2Uge1xuICAgICAgbm9kZVN1Ym5ldFR5cGUgPSBlYzIuU3VibmV0VHlwZS5QVUJMSUM7XG4gICAgfVxuXG4gICAgY29uc3QgbWFzdGVyc1JvbGUgPSBuZXcgaWFtLlJvbGUodGhpcywgY29uc3RydWN0SWQoJ21hc3RlcnMnLCAncm9sZScpLCB7XG4gICAgICBhc3N1bWVkQnk6IG5ldyBpYW0uQWNjb3VudFByaW5jaXBhbChjZGsuU3RhY2sub2YodGhpcykuYWNjb3VudClcbiAgICB9KTtcblxuICAgIGNvbnN0IGNsdXN0ZXIgPSBuZXcgZWtzLkNsdXN0ZXIodGhpcywgY29uc3RydWN0SWQoJ2VrcycsICdjbHVzdGVyJyksIHtcbiAgICAgIGNsdXN0ZXJOYW1lOiB0aGlzLmNsdXN0ZXJOYW1lLFxuICAgICAgdmVyc2lvbjogZWtzLkt1YmVybmV0ZXNWZXJzaW9uLlYxXzIxLFxuICAgICAgdnBjOiB0aGlzLnZwYyxcbiAgICAgIGRlZmF1bHRDYXBhY2l0eTogMCxcbiAgICAgIG1hc3RlcnNSb2xlXG4gICAgfSk7XG4gICAgbWFzdGVyc1JvbGUuYXR0YWNoSW5saW5lUG9saWN5KG5ldyBpYW0uUG9saWN5KHRoaXMsIGNvbnN0cnVjdElkKCdrdWJlY3RsJywgJ3BvbGljeScpLCB7XG4gICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBhY3Rpb25zOiBbJ2t1YmVjdGw6KiddLFxuICAgICAgICAgIHJlc291cmNlczogW2NsdXN0ZXIuY2x1c3RlckFybl1cbiAgICAgICAgfSlcbiAgICAgIF1cbiAgICB9KSk7XG4gICAgY2x1c3Rlci5hZGRBdXRvU2NhbGluZ0dyb3VwQ2FwYWNpdHkoY29uc3RydWN0SWQoJ2VrcycsICdhc2cnLCAnY2FwYWNpdHknKSwge1xuICAgICAgaW5zdGFuY2VUeXBlOiB0aGlzLmluc3RhbmNlVHlwZSxcbiAgICAgIG1pbkNhcGFjaXR5OiB0aGlzLm1pbmltdW1DYXBhY2l0eSxcbiAgICAgIG1heENhcGFjaXR5OiB0aGlzLm1heGltdW1DYXBhY2l0eSxcbiAgICAgIHZwY1N1Ym5ldHM6IHtcbiAgICAgICAgc3VibmV0VHlwZTogbm9kZVN1Ym5ldFR5cGVcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4geyBjbHVzdGVyLCBtYXN0ZXJzUm9sZSB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjb25maWd1cmVMb2FkQmFsYW5jZXJDb250cm9sbGVyICgpIHtcblxuICAgIG5ldyBla3MuQWxiQ29udHJvbGxlcih0aGlzLCAnQWxiQ29udHJvbGxlcicsIHtcbiAgICAgIGNsdXN0ZXI6IHRoaXMuX2NsdXN0ZXIsXG4gICAgICB2ZXJzaW9uOiBla3MuQWxiQ29udHJvbGxlclZlcnNpb24uVjJfNF8xXG4gICAgfSk7XG5cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlT3V0cHV0cyAoKSB7XG4gICAgbmV3IENmbk91dHB1dCh0aGlzLCBjb25zdHJ1Y3RJZCgnY2x1c3RlcicsICduYW1lJyksIHtcbiAgICAgIGRlc2NyaXB0aW9uOiBgJHt0aGlzLmlkfS1jbHVzdGVyLW5hbWVgLFxuICAgICAgdmFsdWU6IHRoaXMuY2x1c3Rlci5jbHVzdGVyTmFtZVxuICAgIH0pO1xuICAgIG5ldyBDZm5PdXRwdXQodGhpcywgY29uc3RydWN0SWQoJ2NsdXN0ZXInLCAnYXJuJyksIHtcbiAgICAgIGRlc2NyaXB0aW9uOiBgJHt0aGlzLmlkfS1jbHVzdGVyLWFybmAsXG4gICAgICB2YWx1ZTogdGhpcy5jbHVzdGVyLmNsdXN0ZXJBcm5cbiAgICB9KTtcbiAgICBuZXcgQ2ZuT3V0cHV0KHRoaXMsIGNvbnN0cnVjdElkKCdjbHVzdGVyJywgJ3JvbGUnLCAnbmFtZScpLCB7XG4gICAgICBkZXNjcmlwdGlvbjogYCR7dGhpcy5pZH0tY2x1c3Rlci1yb2xlLW5hbWVgLFxuICAgICAgdmFsdWU6IHRoaXMuY2x1c3Rlci5yb2xlLnJvbGVOYW1lXG4gICAgfSk7XG4gICAgbmV3IENmbk91dHB1dCh0aGlzLCBjb25zdHJ1Y3RJZCgnY2x1c3RlcicsICdyb2xlJywgJ2FybicpLCB7XG4gICAgICBkZXNjcmlwdGlvbjogYCR7dGhpcy5pZH0tY2x1c3Rlci1yb2xlLWFybmAsXG4gICAgICB2YWx1ZTogdGhpcy5jbHVzdGVyLnJvbGUucm9sZUFyblxuICAgIH0pO1xuICAgIG5ldyBDZm5PdXRwdXQodGhpcywgY29uc3RydWN0SWQoJ2NsdXN0ZXInLCAnYWRtaW4nLCAncm9sZScsICduYW1lJyksIHtcbiAgICAgIGRlc2NyaXB0aW9uOiBgJHt0aGlzLmlkfS1jbHVzdGVyLWFkbWluLXJvbGUtbmFtZWAsXG4gICAgICB2YWx1ZTogdGhpcy5jbHVzdGVyLmFkbWluUm9sZS5yb2xlTmFtZVxuICAgIH0pO1xuICAgIG5ldyBDZm5PdXRwdXQodGhpcywgY29uc3RydWN0SWQoJ2NsdXN0ZXInLCAnYWRtaW4nLCAncm9sZScsICdhcm4nKSwge1xuICAgICAgZGVzY3JpcHRpb246IGAke3RoaXMuaWR9LWNsdXN0ZXItYWRtaW4tcm9sZS1hcm5gLFxuICAgICAgdmFsdWU6IHRoaXMuY2x1c3Rlci5hZG1pblJvbGUucm9sZUFyblxuICAgIH0pO1xuICAgIG5ldyBDZm5PdXRwdXQodGhpcywgY29uc3RydWN0SWQoJ2NsdXN0ZXInLCAna3ViZWN0bCcsICdyb2xlJywgJ25hbWUnKSwge1xuICAgICAgZGVzY3JpcHRpb246IGAke3RoaXMuaWR9LWNsdXN0ZXIta3ViZWN0bC1yb2xlLW5hbWVgLFxuICAgICAgdmFsdWU6IHRoaXMuY2x1c3Rlci5rdWJlY3RsUm9sZT8ucm9sZU5hbWUgfHwgJydcbiAgICB9KTtcbiAgICBuZXcgQ2ZuT3V0cHV0KHRoaXMsIGNvbnN0cnVjdElkKCdjbHVzdGVyJywgJ2t1YmVjdGwnLCAncm9sZScsICdhcm4nKSwge1xuICAgICAgZGVzY3JpcHRpb246IGAke3RoaXMuaWR9LWNsdXN0ZXIta3ViZWN0bC1yb2xlLWFybmAsXG4gICAgICB2YWx1ZTogdGhpcy5jbHVzdGVyLmt1YmVjdGxSb2xlPy5yb2xlQXJuIHx8ICcnXG4gICAgfSk7XG4gICAgbmV3IENmbk91dHB1dCh0aGlzLCBjb25zdHJ1Y3RJZCgnY2x1c3RlcicsICdtYXN0ZXJzJywgJ3JvbGUnLCAnbmFtZScpLCB7XG4gICAgICBkZXNjcmlwdGlvbjogYCR7dGhpcy5pZH0tY2x1c3Rlci1tYXN0ZXJzLXJvbGUtbmFtZWAsXG4gICAgICB2YWx1ZTogdGhpcy5tYXN0ZXJzUm9sZS5yb2xlTmFtZVxuICAgIH0pO1xuICAgIG5ldyBDZm5PdXRwdXQodGhpcywgY29uc3RydWN0SWQoJ2NsdXN0ZXInLCAnbWFzdGVycycsICdyb2xlJywgJ2FybicpLCB7XG4gICAgICBkZXNjcmlwdGlvbjogYCR7dGhpcy5pZH0tY2x1c3Rlci1tYXN0ZXJzLXJvbGUtYXJuYCxcbiAgICAgIHZhbHVlOiB0aGlzLm1hc3RlcnNSb2xlLnJvbGVBcm5cbiAgICB9KTtcbiAgICAvLyBuZXcgQ2ZuT3V0cHV0KHRoaXMsIGNvbnN0cnVjdElkKCdla3MnLCAnY2x1c3RlcicsICdzZXJ2aWNlJywgJ2FjY291bnQnLCAncm9sZScsICduYW1lJyksIHtcbiAgICAvLyAgIGRlc2NyaXB0aW9uOiBgJHt0aGlzLmlkfS1la3MtY2x1c3Rlci1zZXJ2aWNlLWFjY291bnQtcm9sZS1uYW1lYCxcbiAgICAvLyAgIHZhbHVlOiB0aGlzLnNlcnZpY2VBY2NvdW50LnJvbGUucm9sZU5hbWVcbiAgICAvLyB9KTtcbiAgICAvLyBuZXcgQ2ZuT3V0cHV0KHRoaXMsIGNvbnN0cnVjdElkKCdla3MnLCAnY2x1c3RlcicsICdzZXJ2aWNlJywgJ2FjY291bnQnLCAncm9sZScsICdhcm4nKSwge1xuICAgIC8vICAgZGVzY3JpcHRpb246IGAke3RoaXMuaWR9LWVrcy1jbHVzdGVyLXNlcnZpY2UtYWNjb3VudC1yb2xlLWFybmAsXG4gICAgLy8gICB2YWx1ZTogdGhpcy5zZXJ2aWNlQWNjb3VudC5yb2xlLnJvbGVBcm5cbiAgICAvLyB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlVGFnUGFyYW1zIChyZXNvdXJjZXM6IHN0cmluZ1tdLCBrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xuICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgIFJlc291cmNlczogcmVzb3VyY2VzLFxuICAgICAgVGFnczogW1xuICAgICAgICB7XG4gICAgICAgICAgS2V5OiBrZXksXG4gICAgICAgICAgVmFsdWU6IHZhbHVlXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9O1xuICAgIHJldHVybiBwYXJhbXM7XG4gIH1cblxuICBwcml2YXRlIHRhZ1N1Ym5ldHMgKCkge1xuICAgIGNvbnN0IHB1YmxpY1N1Ym5ldHMgPSBbXTtcbiAgICBjb25zdCBwcml2YXRlU3VibmV0cyA9IFtdO1xuICAgIGZvciAoY29uc3Qgc3VibmV0IG9mIHRoaXMuX3ZwYy5wdWJsaWNTdWJuZXRzKSB7XG4gICAgICBwdWJsaWNTdWJuZXRzLnB1c2goc3VibmV0LnN1Ym5ldElkKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBzdWJuZXQgb2YgdGhpcy5fdnBjLnByaXZhdGVTdWJuZXRzKSB7XG4gICAgICBwcml2YXRlU3VibmV0cy5wdXNoKHN1Ym5ldC5zdWJuZXRJZCk7XG4gICAgfVxuICAgIGNvbnN0IHB1YmxpY1RhZ1JlcXVlc3RQYXJhbXMgPSB0aGlzLmNyZWF0ZVRhZ1BhcmFtcyhwdWJsaWNTdWJuZXRzLCAna3ViZXJuZXRlcy5pby9yb2xlL2VsYicsICcxJyk7XG4gICAgY29uc3QgcHJpdmF0ZVRhZ1JlcXVlc3RQYXJhbXMgPSB0aGlzLmNyZWF0ZVRhZ1BhcmFtcyhwdWJsaWNTdWJuZXRzLCAna3ViZXJuZXRlcy5pby9yb2xlL2ludGVybmFsLWVsYicsICcxJyk7XG5cbiAgICBuZXcgU3VibmV0VGFnZ2luZyh0aGlzLCAndGFnUHVibGljU3VibmV0cycsIHsgZWMyUmVzb3VyY2VUYWdzUmVxdWVzdDogcHVibGljVGFnUmVxdWVzdFBhcmFtcyB9KTtcbiAgICBuZXcgU3VibmV0VGFnZ2luZyh0aGlzLCAndGFnUHJpdmF0ZVN1Ym5ldHMnLCB7IGVjMlJlc291cmNlVGFnc1JlcXVlc3Q6IHByaXZhdGVUYWdSZXF1ZXN0UGFyYW1zIH0pO1xuICB9XG5cbiAgcHVibGljIGdldCBjbHVzdGVyICgpOiBla3MuQ2x1c3RlciB7XG4gICAgcmV0dXJuIHRoaXMuX2NsdXN0ZXI7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG1hc3RlcnNSb2xlICgpOiBpYW0uUm9sZSB7XG4gICAgcmV0dXJuIHRoaXMuX21hc3RlcnNSb2xlO1xuICB9XG5cbiAgcHVibGljIGdldCB2cGMgKCk6IGVjMi5JVnBjIHtcbiAgICByZXR1cm4gdGhpcy5fdnBjO1xuICB9XG5cbiAgcHVibGljIGdldCBpbnRlcm5ldEFjY2VzcyAoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2ludGVybmV0QWNjZXNzO1xuICB9XG5cbiAgcHVibGljIGdldCBkZWZhdWx0Q2FwYWNpdHkgKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX2RlZmF1bHRDYXBhY2l0eTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbWluaW11bUNhcGFjaXR5ICgpOiBudW1iZXIgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLl9taW5pbXVtQ2FwYWNpdHk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG1heGltdW1DYXBhY2l0eSAoKTogbnVtYmVyIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5fbWF4aW11bUNhcGFjaXR5O1xuICB9XG5cbiAgcHVibGljIGdldCBpbnN0YW5jZVR5cGUgKCk6IEluc3RhbmNlVHlwZSB7XG4gICAgcmV0dXJuIHRoaXMuX2luc3RhbmNlVHlwZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc2VydmljZUFjY291bnQgKCk6IGVrcy5TZXJ2aWNlQWNjb3VudCB7XG4gICAgcmV0dXJuIHRoaXMuX3NlcnZpY2VBY2NvdW50O1xuICB9XG5cbiAgcHVibGljIGdldCBjbHVzdGVyTmFtZSAoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5fY2x1c3Rlck5hbWU7XG4gIH1cbiAgcHVibGljIGdldCBjbHVzdGVyTmFtZVBhcmFtZXRlck5hbWUgKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX2NsdXN0ZXJOYW1lU3NtUGFyYW1OYW1lO1xuICB9XG59Il19