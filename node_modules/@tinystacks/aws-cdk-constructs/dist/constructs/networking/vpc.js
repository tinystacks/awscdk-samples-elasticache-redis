"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.VPC = void 0;
const iac_utils_1 = require("@tinystacks/iac-utils");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const ec2 = __importStar(require("aws-cdk-lib/aws-ec2"));
const constructs_1 = require("constructs");
const crypto_1 = require("crypto");
const vpc_peer_dns_resolution_1 = require("./vpc-peer-dns-resolution");
const vpc_peering_request_accepter_1 = require("./vpc-peering-request-accepter");
const vpc_peering_routes_1 = require("./vpc-peering-routes");
class VPC extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const { cidrBlock, internetAccess, internalPeers, externalPeers } = props;
        this.internetAccess = internetAccess;
        this.accountId = aws_cdk_lib_1.Stack.of(this).account;
        this.region = aws_cdk_lib_1.Stack.of(this).region;
        if (cidrBlock) {
            this._cidrBlock = cidrBlock;
            this.cidrBlockMask = Number(cidrBlock?.split('/')?.at(1));
        }
        else {
            const autoAllocatedCidrBlock = (0, iac_utils_1.allocateCidrBlock)({ seed: id });
            this._cidrBlock = autoAllocatedCidrBlock.cidrBlock;
            this.cidrBlockMask = autoAllocatedCidrBlock.networkMask;
        }
        const stackAzs = aws_cdk_lib_1.Stack.of(this).availabilityZones;
        const azCount = stackAzs.length;
        const maxSubnetCount = azCount * 3; // Allow 1 subnet type in each availability zone
        this.subnetMask = (0, iac_utils_1.allocateSubnetMask)(this.cidrBlockMask, maxSubnetCount);
        this.subnetConfiguration = [];
        if (internetAccess) {
            const privateSubnetConfig = {
                cidrMask: this.subnetMask,
                name: 'PrivateSubnet',
                subnetType: ec2.SubnetType.PRIVATE_WITH_NAT
            };
            this.subnetConfiguration.push(privateSubnetConfig);
        }
        const publicSubnetConfig = {
            cidrMask: this.subnetMask,
            name: 'PublicSubnet',
            subnetType: ec2.SubnetType.PUBLIC
        };
        this.subnetConfiguration.push(publicSubnetConfig);
        const isolatedSubnetConfig = {
            cidrMask: this.subnetMask,
            name: 'IsolatedSubnet',
            subnetType: ec2.SubnetType.PRIVATE_ISOLATED
        };
        this.subnetConfiguration.push(isolatedSubnetConfig);
        this._vpc = new ec2.Vpc(this, (0, iac_utils_1.constructId)('vpc'), {
            cidr: this.cidrBlock,
            subnetConfiguration: this.subnetConfiguration
        });
        new aws_cdk_lib_1.CfnOutput(this, (0, iac_utils_1.constructId)('vpc', 'id'), {
            description: `${id}-vpc-id`,
            value: this.vpc.vpcId
        });
        if (internalPeers != null) {
            for (const internalPeer of internalPeers) {
                const connectionId = `${this.vpc.vpcId}-to-${internalPeer.vpc.vpcId}`;
                const peeringConnectionRequest = this.requestPeeringConnection(internalPeer, connectionId);
                const peeringConnectionId = peeringConnectionRequest.ref;
                internalPeer.acceptPeeringConnection(this, peeringConnectionId, connectionId);
            }
        }
        if (externalPeers != null) {
            for (const externalPeer of externalPeers) {
                const connectionId = `${this.vpc.vpcId}-to-${externalPeer.vpcId}`;
                const peeringConnectionRequest = this.requestExternalPeeringConnection(externalPeer, connectionId);
                const peeringConnectionId = peeringConnectionRequest.ref;
                this.acceptExternalPeeringConnection(externalPeer, peeringConnectionId, connectionId);
            }
        }
    }
    requestPeeringConnection(peer, connectionId) {
        if (this.cidrBlock === peer.cidrBlock) {
            throw new Error('Cannot peer two vpcs with the same cidr block!');
        }
        const peerPairId = `vpc-peering-connection-${connectionId}`;
        const peeringConnectionRequest = new ec2.CfnVPCPeeringConnection(this, (0, iac_utils_1.constructId)(peerPairId), {
            peerVpcId: peer.vpc.vpcId,
            vpcId: this.vpc.vpcId
        });
        this.addPeeringRoutes(peeringConnectionRequest.ref, peer.cidrBlock, connectionId);
        new vpc_peer_dns_resolution_1.VpcPeerDnsResolution(this, (0, iac_utils_1.constructId)(`requester-dns-resolution-${connectionId}`), {
            peeringConnectionId: peeringConnectionRequest.ref,
            vpcArn: this.vpc.vpcArn,
            accountId: this.accountId,
            region: this.region,
            isRequester: true
        });
        return peeringConnectionRequest;
    }
    acceptPeeringConnection(requester, peeringConnectionId, connectionId) {
        this.addPeeringRoutes(peeringConnectionId, requester.cidrBlock, connectionId);
        new vpc_peer_dns_resolution_1.VpcPeerDnsResolution(this, (0, iac_utils_1.constructId)(`accepter-dns-resolution-${connectionId}`), {
            peeringConnectionId,
            vpcArn: this.vpc.vpcArn,
            accountId: this.accountId,
            region: this.region,
            isAccepter: true
        });
    }
    requestExternalPeeringConnection(peer, connectionId) {
        if (this.cidrBlock === peer.cidrBlock) {
            throw new Error('Cannot peer two vpcs with the same cidr block!');
        }
        const peerPairId = `vpc-peering-connection-${connectionId}`;
        const peeringConnectionRequest = new ec2.CfnVPCPeeringConnection(this, (0, iac_utils_1.constructId)(peerPairId), {
            peerVpcId: peer.vpcId,
            vpcId: this.vpc.vpcId
        });
        this.addPeeringRoutes(peeringConnectionRequest.ref, peer.cidrBlock, connectionId);
        new vpc_peer_dns_resolution_1.VpcPeerDnsResolution(this, (0, iac_utils_1.constructId)(`requester-dns-resolution-${connectionId}`), {
            peeringConnectionId: peeringConnectionRequest.ref,
            vpcArn: this.vpc.vpcArn,
            accountId: this.accountId,
            region: this.region,
            isRequester: true
        });
        return peeringConnectionRequest;
    }
    acceptExternalPeeringConnection(peer, peeringConnectionId, connectionId) {
        const { accountId = this.accountId, region = this.region, vpcId } = peer;
        const externalVpcArn = `arn:aws:ec2:${region}:${accountId}:vpc/${vpcId}`;
        new vpc_peering_request_accepter_1.VpcPeeringRequestAccepter(this, (0, iac_utils_1.constructId)('PeeringRequestAccepter', connectionId), {
            vpcArn: externalVpcArn,
            peeringConnectionId,
            accountId,
            region
        });
        new vpc_peering_routes_1.VpcPeeringRoutes(this, (0, iac_utils_1.constructId)('ExternalVpcPeeringRoutes', connectionId), {
            vpcId: peer.vpcId,
            peeringConnectionId,
            destinationCidrBlock: this.cidrBlock,
            accountId,
            region,
            uniqueId: (0, crypto_1.randomUUID)()
        });
        new vpc_peer_dns_resolution_1.VpcPeerDnsResolution(this, (0, iac_utils_1.constructId)(`accepter-dns-resolution-${connectionId}`), {
            peeringConnectionId,
            vpcArn: externalVpcArn,
            accountId,
            region,
            isAccepter: true
        });
    }
    addPeeringRoutes(peeringConnectionId, destinationCidrBlock, connectionId) {
        this.vpc.publicSubnets.forEach((ps, index) => {
            const { routeTable } = ps;
            new ec2.CfnRoute(this, (0, iac_utils_1.constructId)(`PublicPeeringRoute${index}-${connectionId}`), {
                routeTableId: routeTable.routeTableId,
                destinationCidrBlock,
                vpcPeeringConnectionId: peeringConnectionId
            });
        });
        if (this.internetAccess) {
            this.vpc.privateSubnets.forEach((ps, index) => {
                const { routeTable } = ps;
                new ec2.CfnRoute(this, (0, iac_utils_1.constructId)(`PrivatePeeringRoute${index}-${connectionId}`), {
                    routeTableId: routeTable.routeTableId,
                    destinationCidrBlock,
                    vpcPeeringConnectionId: peeringConnectionId
                });
            });
        }
        this.vpc.isolatedSubnets.forEach((ps, index) => {
            const { routeTable } = ps;
            new ec2.CfnRoute(this, (0, iac_utils_1.constructId)(`IsolatedPeeringRoute${index}-${connectionId}`), {
                routeTableId: routeTable.routeTableId,
                destinationCidrBlock,
                vpcPeeringConnectionId: peeringConnectionId
            });
        });
    }
    get vpc() {
        return this._vpc;
    }
    get cidrBlock() {
        return this._cidrBlock;
    }
}
exports.VPC = VPC;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidnBjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbnN0cnVjdHMvbmV0d29ya2luZy92cGMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxxREFBMkY7QUFDM0YsNkNBQStDO0FBQy9DLHlEQUEyQztBQUMzQywyQ0FBdUM7QUFDdkMsbUNBQW9DO0FBQ3BDLHVFQUFpRTtBQUNqRSxpRkFBMkU7QUFDM0UsNkRBQXdEO0FBZ0J4RCxNQUFhLEdBQUksU0FBUSxzQkFBUztJQVVoQyxZQUFhLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWU7UUFDeEQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLEVBQ0osU0FBUyxFQUNULGNBQWMsRUFDZCxhQUFhLEVBQ2IsYUFBYSxFQUNkLEdBQUcsS0FBSyxDQUFDO1FBRVYsSUFBSSxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7UUFFckMsSUFBSSxDQUFDLFNBQVMsR0FBRyxtQkFBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDeEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxtQkFBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFFcEMsSUFBSSxTQUFTLEVBQUU7WUFDYixJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztZQUM1QixJQUFJLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzNEO2FBQU07WUFDTCxNQUFNLHNCQUFzQixHQUFHLElBQUEsNkJBQWlCLEVBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMvRCxJQUFJLENBQUMsVUFBVSxHQUFHLHNCQUFzQixDQUFDLFNBQVMsQ0FBQztZQUNuRCxJQUFJLENBQUMsYUFBYSxHQUFHLHNCQUFzQixDQUFDLFdBQVcsQ0FBQztTQUN6RDtRQUVELE1BQU0sUUFBUSxHQUFHLG1CQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLGlCQUFpQixDQUFDO1FBQ2xELE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7UUFDaEMsTUFBTSxjQUFjLEdBQUcsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLGdEQUFnRDtRQUNwRixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUEsOEJBQWtCLEVBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUV6RSxJQUFJLENBQUMsbUJBQW1CLEdBQUcsRUFBRSxDQUFDO1FBRTlCLElBQUksY0FBYyxFQUFFO1lBQ2xCLE1BQU0sbUJBQW1CLEdBQUc7Z0JBQzFCLFFBQVEsRUFBRSxJQUFJLENBQUMsVUFBVTtnQkFDekIsSUFBSSxFQUFFLGVBQWU7Z0JBQ3JCLFVBQVUsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLGdCQUFnQjthQUM1QyxDQUFDO1lBQ0YsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1NBQ3BEO1FBRUQsTUFBTSxrQkFBa0IsR0FBRztZQUN6QixRQUFRLEVBQUUsSUFBSSxDQUFDLFVBQVU7WUFDekIsSUFBSSxFQUFFLGNBQWM7WUFDcEIsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTTtTQUNsQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBRWxELE1BQU0sb0JBQW9CLEdBQUc7WUFDM0IsUUFBUSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQ3pCLElBQUksRUFBRSxnQkFBZ0I7WUFDdEIsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsZ0JBQWdCO1NBQzVDLENBQUM7UUFDRixJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFFcEQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUEsdUJBQVcsRUFBQyxLQUFLLENBQUMsRUFBRTtZQUNoRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDcEIsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLG1CQUFtQjtTQUM5QyxDQUFDLENBQUM7UUFFSCxJQUFJLHVCQUFTLENBQUMsSUFBSSxFQUFFLElBQUEsdUJBQVcsRUFBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDNUMsV0FBVyxFQUFFLEdBQUcsRUFBRSxTQUFTO1lBQzNCLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUs7U0FDdEIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxhQUFhLElBQUksSUFBSSxFQUFFO1lBQ3pCLEtBQUssTUFBTSxZQUFZLElBQUksYUFBYSxFQUFFO2dCQUN4QyxNQUFNLFlBQVksR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxPQUFPLFlBQVksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ3RFLE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFlBQVksRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFDM0YsTUFBTSxtQkFBbUIsR0FBRyx3QkFBd0IsQ0FBQyxHQUFHLENBQUM7Z0JBQ3pELFlBQVksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLEVBQUUsWUFBWSxDQUFDLENBQUM7YUFDL0U7U0FDRjtRQUNELElBQUksYUFBYSxJQUFJLElBQUksRUFBRTtZQUN6QixLQUFLLE1BQU0sWUFBWSxJQUFJLGFBQWEsRUFBRTtnQkFDeEMsTUFBTSxZQUFZLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssT0FBTyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBQ2xFLE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLFlBQVksRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFDbkcsTUFBTSxtQkFBbUIsR0FBRyx3QkFBd0IsQ0FBQyxHQUFHLENBQUM7Z0JBQ3pELElBQUksQ0FBQywrQkFBK0IsQ0FBQyxZQUFZLEVBQUUsbUJBQW1CLEVBQUUsWUFBWSxDQUFDLENBQUM7YUFDdkY7U0FDRjtJQUNILENBQUM7SUFFTSx3QkFBd0IsQ0FBRSxJQUFTLEVBQUUsWUFBb0I7UUFDOUQsSUFBSSxJQUFJLENBQUMsU0FBUyxLQUFLLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDckMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO1NBQ25FO1FBRUQsTUFBTSxVQUFVLEdBQUcsMEJBQTBCLFlBQVksRUFBRSxDQUFDO1FBQzVELE1BQU0sd0JBQXdCLEdBQUcsSUFBSSxHQUFHLENBQUMsdUJBQXVCLENBQzlELElBQUksRUFDSixJQUFBLHVCQUFXLEVBQUMsVUFBVSxDQUFDLEVBQ3ZCO1lBQ0UsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSztZQUN6QixLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLO1NBQ3RCLENBQ0YsQ0FBQztRQUNGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyx3QkFBd0IsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNsRixJQUFJLDhDQUFvQixDQUFDLElBQUksRUFBRSxJQUFBLHVCQUFXLEVBQUMsNEJBQTRCLFlBQVksRUFBRSxDQUFDLEVBQUU7WUFDdEYsbUJBQW1CLEVBQUUsd0JBQXdCLENBQUMsR0FBRztZQUNqRCxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNO1lBQ3ZCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07WUFDbkIsV0FBVyxFQUFFLElBQUk7U0FDbEIsQ0FBQyxDQUFDO1FBQ0gsT0FBTyx3QkFBd0IsQ0FBQztJQUNsQyxDQUFDO0lBRU0sdUJBQXVCLENBQUUsU0FBYyxFQUFFLG1CQUEyQixFQUFFLFlBQW9CO1FBQy9GLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxtQkFBbUIsRUFBRSxTQUFTLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQzlFLElBQUksOENBQW9CLENBQUMsSUFBSSxFQUFFLElBQUEsdUJBQVcsRUFBQywyQkFBMkIsWUFBWSxFQUFFLENBQUMsRUFBRTtZQUNyRixtQkFBbUI7WUFDbkIsTUFBTSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTTtZQUN2QixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDekIsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO1lBQ25CLFVBQVUsRUFBRSxJQUFJO1NBQ2pCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxnQ0FBZ0MsQ0FBRSxJQUFxQixFQUFFLFlBQW9CO1FBQ2xGLElBQUksSUFBSSxDQUFDLFNBQVMsS0FBSyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ3JDLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0RBQWdELENBQUMsQ0FBQztTQUNuRTtRQUNELE1BQU0sVUFBVSxHQUFHLDBCQUEwQixZQUFZLEVBQUUsQ0FBQztRQUM1RCxNQUFNLHdCQUF3QixHQUFHLElBQUksR0FBRyxDQUFDLHVCQUF1QixDQUM5RCxJQUFJLEVBQ0osSUFBQSx1QkFBVyxFQUFDLFVBQVUsQ0FBQyxFQUN2QjtZQUNFLFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSztZQUNyQixLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLO1NBQ3RCLENBQ0YsQ0FBQztRQUNGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyx3QkFBd0IsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNsRixJQUFJLDhDQUFvQixDQUFDLElBQUksRUFBRSxJQUFBLHVCQUFXLEVBQUMsNEJBQTRCLFlBQVksRUFBRSxDQUFDLEVBQUU7WUFDdEYsbUJBQW1CLEVBQUUsd0JBQXdCLENBQUMsR0FBRztZQUNqRCxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNO1lBQ3ZCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07WUFDbkIsV0FBVyxFQUFFLElBQUk7U0FDbEIsQ0FBQyxDQUFDO1FBQ0gsT0FBTyx3QkFBd0IsQ0FBQztJQUNsQyxDQUFDO0lBRU0sK0JBQStCLENBQUUsSUFBcUIsRUFBRSxtQkFBMkIsRUFBRSxZQUFvQjtRQUM5RyxNQUFNLEVBQ0osU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQzFCLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUNwQixLQUFLLEVBQ04sR0FBRyxJQUFJLENBQUM7UUFFVCxNQUFNLGNBQWMsR0FBRyxlQUFlLE1BQU0sSUFBSSxTQUFTLFFBQVEsS0FBSyxFQUFFLENBQUM7UUFFekUsSUFBSSx3REFBeUIsQ0FBQyxJQUFJLEVBQUUsSUFBQSx1QkFBVyxFQUFDLHdCQUF3QixFQUFFLFlBQVksQ0FBQyxFQUFFO1lBQ3ZGLE1BQU0sRUFBRSxjQUFjO1lBQ3RCLG1CQUFtQjtZQUNuQixTQUFTO1lBQ1QsTUFBTTtTQUNQLENBQUMsQ0FBQztRQUNILElBQUkscUNBQWdCLENBQUMsSUFBSSxFQUFFLElBQUEsdUJBQVcsRUFBQywwQkFBMEIsRUFBRSxZQUFZLENBQUMsRUFBRTtZQUNoRixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDakIsbUJBQW1CO1lBQ25CLG9CQUFvQixFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3BDLFNBQVM7WUFDVCxNQUFNO1lBQ04sUUFBUSxFQUFFLElBQUEsbUJBQVUsR0FBRTtTQUN2QixDQUFDLENBQUM7UUFDSCxJQUFJLDhDQUFvQixDQUFDLElBQUksRUFBRSxJQUFBLHVCQUFXLEVBQUMsMkJBQTJCLFlBQVksRUFBRSxDQUFDLEVBQUU7WUFDckYsbUJBQW1CO1lBQ25CLE1BQU0sRUFBRSxjQUFjO1lBQ3RCLFNBQVM7WUFDVCxNQUFNO1lBQ04sVUFBVSxFQUFFLElBQUk7U0FDakIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLGdCQUFnQixDQUFFLG1CQUEyQixFQUFFLG9CQUE0QixFQUFFLFlBQW9CO1FBQ3RHLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUMzQyxNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBZ0IsQ0FBQztZQUN4QyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLElBQUEsdUJBQVcsRUFBQyxxQkFBcUIsS0FBSyxJQUFJLFlBQVksRUFBRSxDQUFDLEVBQUU7Z0JBQ2hGLFlBQVksRUFBRSxVQUFVLENBQUMsWUFBWTtnQkFDckMsb0JBQW9CO2dCQUNwQixzQkFBc0IsRUFBRSxtQkFBbUI7YUFDNUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDdkIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFO2dCQUM1QyxNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBZ0IsQ0FBQztnQkFDeEMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxJQUFBLHVCQUFXLEVBQUMsc0JBQXNCLEtBQUssSUFBSSxZQUFZLEVBQUUsQ0FBQyxFQUFFO29CQUNqRixZQUFZLEVBQUUsVUFBVSxDQUFDLFlBQVk7b0JBQ3JDLG9CQUFvQjtvQkFDcEIsc0JBQXNCLEVBQUUsbUJBQW1CO2lCQUM1QyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBRUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQzdDLE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFnQixDQUFDO1lBQ3hDLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBQSx1QkFBVyxFQUFDLHVCQUF1QixLQUFLLElBQUksWUFBWSxFQUFFLENBQUMsRUFBRTtnQkFDbEYsWUFBWSxFQUFFLFVBQVUsQ0FBQyxZQUFZO2dCQUNyQyxvQkFBb0I7Z0JBQ3BCLHNCQUFzQixFQUFFLG1CQUFtQjthQUM1QyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFXLEdBQUc7UUFDWixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDbkIsQ0FBQztJQUVELElBQVcsU0FBUztRQUNsQixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDekIsQ0FBQztDQUNGO0FBOU5ELGtCQThOQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFsbG9jYXRlQ2lkckJsb2NrLCBhbGxvY2F0ZVN1Ym5ldE1hc2ssIGNvbnN0cnVjdElkIH0gZnJvbSAnQHRpbnlzdGFja3MvaWFjLXV0aWxzJztcbmltcG9ydCB7IENmbk91dHB1dCwgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnYXdzLWNkay1saWIvYXdzLWVjMic7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IHJhbmRvbVVVSUQgfSBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IHsgVnBjUGVlckRuc1Jlc29sdXRpb24gfSBmcm9tICcuL3ZwYy1wZWVyLWRucy1yZXNvbHV0aW9uJztcbmltcG9ydCB7IFZwY1BlZXJpbmdSZXF1ZXN0QWNjZXB0ZXIgfSBmcm9tICcuL3ZwYy1wZWVyaW5nLXJlcXVlc3QtYWNjZXB0ZXInO1xuaW1wb3J0IHsgVnBjUGVlcmluZ1JvdXRlcyB9IGZyb20gJy4vdnBjLXBlZXJpbmctcm91dGVzJztcblxuaW50ZXJmYWNlIEV4dGVybmFsVnBjUGVlciB7XG4gIHZwY0lkOiBzdHJpbmdcbiAgY2lkckJsb2NrOiBzdHJpbmdcbiAgYWNjb3VudElkPzogc3RyaW5nXG4gIHJlZ2lvbj86IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFZwY1Byb3BzIHtcbiAgY2lkckJsb2NrPzogc3RyaW5nXG4gIGludGVybmV0QWNjZXNzOiBib29sZWFuXG4gIGludGVybmFsUGVlcnM/OiBWUENbXVxuICBleHRlcm5hbFBlZXJzPzogRXh0ZXJuYWxWcGNQZWVyW11cbn1cblxuZXhwb3J0IGNsYXNzIFZQQyBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgX3ZwYzogZWMyLklWcGM7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3VibmV0Q29uZmlndXJhdGlvbjogQXJyYXk8eyBjaWRyTWFzazogbnVtYmVyLCBuYW1lOiBzdHJpbmcsIHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlIH0+O1xuICBwcml2YXRlIHJlYWRvbmx5IF9jaWRyQmxvY2s6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBjaWRyQmxvY2tNYXNrOiBudW1iZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgc3VibmV0TWFzazogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGludGVybmV0QWNjZXNzOiBib29sZWFuO1xuICBwcml2YXRlIHJlYWRvbmx5IGFjY291bnRJZDogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlZ2lvbjogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yIChzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogVnBjUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qge1xuICAgICAgY2lkckJsb2NrLFxuICAgICAgaW50ZXJuZXRBY2Nlc3MsXG4gICAgICBpbnRlcm5hbFBlZXJzLFxuICAgICAgZXh0ZXJuYWxQZWVyc1xuICAgIH0gPSBwcm9wcztcblxuICAgIHRoaXMuaW50ZXJuZXRBY2Nlc3MgPSBpbnRlcm5ldEFjY2VzcztcblxuICAgIHRoaXMuYWNjb3VudElkID0gU3RhY2sub2YodGhpcykuYWNjb3VudDtcbiAgICB0aGlzLnJlZ2lvbiA9IFN0YWNrLm9mKHRoaXMpLnJlZ2lvbjtcblxuICAgIGlmIChjaWRyQmxvY2spIHtcbiAgICAgIHRoaXMuX2NpZHJCbG9jayA9IGNpZHJCbG9jaztcbiAgICAgIHRoaXMuY2lkckJsb2NrTWFzayA9IE51bWJlcihjaWRyQmxvY2s/LnNwbGl0KCcvJyk/LmF0KDEpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYXV0b0FsbG9jYXRlZENpZHJCbG9jayA9IGFsbG9jYXRlQ2lkckJsb2NrKHsgc2VlZDogaWQgfSk7XG4gICAgICB0aGlzLl9jaWRyQmxvY2sgPSBhdXRvQWxsb2NhdGVkQ2lkckJsb2NrLmNpZHJCbG9jaztcbiAgICAgIHRoaXMuY2lkckJsb2NrTWFzayA9IGF1dG9BbGxvY2F0ZWRDaWRyQmxvY2submV0d29ya01hc2s7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhY2tBenMgPSBTdGFjay5vZih0aGlzKS5hdmFpbGFiaWxpdHlab25lcztcbiAgICBjb25zdCBhekNvdW50ID0gc3RhY2tBenMubGVuZ3RoO1xuICAgIGNvbnN0IG1heFN1Ym5ldENvdW50ID0gYXpDb3VudCAqIDM7IC8vIEFsbG93IDEgc3VibmV0IHR5cGUgaW4gZWFjaCBhdmFpbGFiaWxpdHkgem9uZVxuICAgIHRoaXMuc3VibmV0TWFzayA9IGFsbG9jYXRlU3VibmV0TWFzayh0aGlzLmNpZHJCbG9ja01hc2ssIG1heFN1Ym5ldENvdW50KTtcblxuICAgIHRoaXMuc3VibmV0Q29uZmlndXJhdGlvbiA9IFtdO1xuXG4gICAgaWYgKGludGVybmV0QWNjZXNzKSB7XG4gICAgICBjb25zdCBwcml2YXRlU3VibmV0Q29uZmlnID0ge1xuICAgICAgICBjaWRyTWFzazogdGhpcy5zdWJuZXRNYXNrLFxuICAgICAgICBuYW1lOiAnUHJpdmF0ZVN1Ym5ldCcsXG4gICAgICAgIHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBSSVZBVEVfV0lUSF9OQVRcbiAgICAgIH07XG4gICAgICB0aGlzLnN1Ym5ldENvbmZpZ3VyYXRpb24ucHVzaChwcml2YXRlU3VibmV0Q29uZmlnKTtcbiAgICB9XG5cbiAgICBjb25zdCBwdWJsaWNTdWJuZXRDb25maWcgPSB7XG4gICAgICBjaWRyTWFzazogdGhpcy5zdWJuZXRNYXNrLFxuICAgICAgbmFtZTogJ1B1YmxpY1N1Ym5ldCcsXG4gICAgICBzdWJuZXRUeXBlOiBlYzIuU3VibmV0VHlwZS5QVUJMSUNcbiAgICB9O1xuICAgIHRoaXMuc3VibmV0Q29uZmlndXJhdGlvbi5wdXNoKHB1YmxpY1N1Ym5ldENvbmZpZyk7XG5cbiAgICBjb25zdCBpc29sYXRlZFN1Ym5ldENvbmZpZyA9IHtcbiAgICAgIGNpZHJNYXNrOiB0aGlzLnN1Ym5ldE1hc2ssXG4gICAgICBuYW1lOiAnSXNvbGF0ZWRTdWJuZXQnLFxuICAgICAgc3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFJJVkFURV9JU09MQVRFRFxuICAgIH07XG4gICAgdGhpcy5zdWJuZXRDb25maWd1cmF0aW9uLnB1c2goaXNvbGF0ZWRTdWJuZXRDb25maWcpO1xuXG4gICAgdGhpcy5fdnBjID0gbmV3IGVjMi5WcGModGhpcywgY29uc3RydWN0SWQoJ3ZwYycpLCB7XG4gICAgICBjaWRyOiB0aGlzLmNpZHJCbG9jayxcbiAgICAgIHN1Ym5ldENvbmZpZ3VyYXRpb246IHRoaXMuc3VibmV0Q29uZmlndXJhdGlvblxuICAgIH0pO1xuXG4gICAgbmV3IENmbk91dHB1dCh0aGlzLCBjb25zdHJ1Y3RJZCgndnBjJywgJ2lkJyksIHtcbiAgICAgIGRlc2NyaXB0aW9uOiBgJHtpZH0tdnBjLWlkYCxcbiAgICAgIHZhbHVlOiB0aGlzLnZwYy52cGNJZFxuICAgIH0pO1xuXG4gICAgaWYgKGludGVybmFsUGVlcnMgIT0gbnVsbCkge1xuICAgICAgZm9yIChjb25zdCBpbnRlcm5hbFBlZXIgb2YgaW50ZXJuYWxQZWVycykge1xuICAgICAgICBjb25zdCBjb25uZWN0aW9uSWQgPSBgJHt0aGlzLnZwYy52cGNJZH0tdG8tJHtpbnRlcm5hbFBlZXIudnBjLnZwY0lkfWA7XG4gICAgICAgIGNvbnN0IHBlZXJpbmdDb25uZWN0aW9uUmVxdWVzdCA9IHRoaXMucmVxdWVzdFBlZXJpbmdDb25uZWN0aW9uKGludGVybmFsUGVlciwgY29ubmVjdGlvbklkKTtcbiAgICAgICAgY29uc3QgcGVlcmluZ0Nvbm5lY3Rpb25JZCA9IHBlZXJpbmdDb25uZWN0aW9uUmVxdWVzdC5yZWY7XG4gICAgICAgIGludGVybmFsUGVlci5hY2NlcHRQZWVyaW5nQ29ubmVjdGlvbih0aGlzLCBwZWVyaW5nQ29ubmVjdGlvbklkLCBjb25uZWN0aW9uSWQpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWxQZWVycyAhPSBudWxsKSB7XG4gICAgICBmb3IgKGNvbnN0IGV4dGVybmFsUGVlciBvZiBleHRlcm5hbFBlZXJzKSB7XG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JZCA9IGAke3RoaXMudnBjLnZwY0lkfS10by0ke2V4dGVybmFsUGVlci52cGNJZH1gO1xuICAgICAgICBjb25zdCBwZWVyaW5nQ29ubmVjdGlvblJlcXVlc3QgPSB0aGlzLnJlcXVlc3RFeHRlcm5hbFBlZXJpbmdDb25uZWN0aW9uKGV4dGVybmFsUGVlciwgY29ubmVjdGlvbklkKTtcbiAgICAgICAgY29uc3QgcGVlcmluZ0Nvbm5lY3Rpb25JZCA9IHBlZXJpbmdDb25uZWN0aW9uUmVxdWVzdC5yZWY7XG4gICAgICAgIHRoaXMuYWNjZXB0RXh0ZXJuYWxQZWVyaW5nQ29ubmVjdGlvbihleHRlcm5hbFBlZXIsIHBlZXJpbmdDb25uZWN0aW9uSWQsIGNvbm5lY3Rpb25JZCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlcXVlc3RQZWVyaW5nQ29ubmVjdGlvbiAocGVlcjogVlBDLCBjb25uZWN0aW9uSWQ6IHN0cmluZykge1xuICAgIGlmICh0aGlzLmNpZHJCbG9jayA9PT0gcGVlci5jaWRyQmxvY2spIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHBlZXIgdHdvIHZwY3Mgd2l0aCB0aGUgc2FtZSBjaWRyIGJsb2NrIScpO1xuICAgIH1cblxuICAgIGNvbnN0IHBlZXJQYWlySWQgPSBgdnBjLXBlZXJpbmctY29ubmVjdGlvbi0ke2Nvbm5lY3Rpb25JZH1gO1xuICAgIGNvbnN0IHBlZXJpbmdDb25uZWN0aW9uUmVxdWVzdCA9IG5ldyBlYzIuQ2ZuVlBDUGVlcmluZ0Nvbm5lY3Rpb24oXG4gICAgICB0aGlzLFxuICAgICAgY29uc3RydWN0SWQocGVlclBhaXJJZCksXG4gICAgICB7XG4gICAgICAgIHBlZXJWcGNJZDogcGVlci52cGMudnBjSWQsXG4gICAgICAgIHZwY0lkOiB0aGlzLnZwYy52cGNJZFxuICAgICAgfVxuICAgICk7XG4gICAgdGhpcy5hZGRQZWVyaW5nUm91dGVzKHBlZXJpbmdDb25uZWN0aW9uUmVxdWVzdC5yZWYsIHBlZXIuY2lkckJsb2NrLCBjb25uZWN0aW9uSWQpO1xuICAgIG5ldyBWcGNQZWVyRG5zUmVzb2x1dGlvbih0aGlzLCBjb25zdHJ1Y3RJZChgcmVxdWVzdGVyLWRucy1yZXNvbHV0aW9uLSR7Y29ubmVjdGlvbklkfWApLCB7XG4gICAgICBwZWVyaW5nQ29ubmVjdGlvbklkOiBwZWVyaW5nQ29ubmVjdGlvblJlcXVlc3QucmVmLFxuICAgICAgdnBjQXJuOiB0aGlzLnZwYy52cGNBcm4sXG4gICAgICBhY2NvdW50SWQ6IHRoaXMuYWNjb3VudElkLFxuICAgICAgcmVnaW9uOiB0aGlzLnJlZ2lvbixcbiAgICAgIGlzUmVxdWVzdGVyOiB0cnVlXG4gICAgfSk7XG4gICAgcmV0dXJuIHBlZXJpbmdDb25uZWN0aW9uUmVxdWVzdDtcbiAgfVxuXG4gIHB1YmxpYyBhY2NlcHRQZWVyaW5nQ29ubmVjdGlvbiAocmVxdWVzdGVyOiBWUEMsIHBlZXJpbmdDb25uZWN0aW9uSWQ6IHN0cmluZywgY29ubmVjdGlvbklkOiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZFBlZXJpbmdSb3V0ZXMocGVlcmluZ0Nvbm5lY3Rpb25JZCwgcmVxdWVzdGVyLmNpZHJCbG9jaywgY29ubmVjdGlvbklkKTtcbiAgICBuZXcgVnBjUGVlckRuc1Jlc29sdXRpb24odGhpcywgY29uc3RydWN0SWQoYGFjY2VwdGVyLWRucy1yZXNvbHV0aW9uLSR7Y29ubmVjdGlvbklkfWApLCB7XG4gICAgICBwZWVyaW5nQ29ubmVjdGlvbklkLFxuICAgICAgdnBjQXJuOiB0aGlzLnZwYy52cGNBcm4sXG4gICAgICBhY2NvdW50SWQ6IHRoaXMuYWNjb3VudElkLFxuICAgICAgcmVnaW9uOiB0aGlzLnJlZ2lvbixcbiAgICAgIGlzQWNjZXB0ZXI6IHRydWVcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyByZXF1ZXN0RXh0ZXJuYWxQZWVyaW5nQ29ubmVjdGlvbiAocGVlcjogRXh0ZXJuYWxWcGNQZWVyLCBjb25uZWN0aW9uSWQ6IHN0cmluZykge1xuICAgIGlmICh0aGlzLmNpZHJCbG9jayA9PT0gcGVlci5jaWRyQmxvY2spIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHBlZXIgdHdvIHZwY3Mgd2l0aCB0aGUgc2FtZSBjaWRyIGJsb2NrIScpO1xuICAgIH1cbiAgICBjb25zdCBwZWVyUGFpcklkID0gYHZwYy1wZWVyaW5nLWNvbm5lY3Rpb24tJHtjb25uZWN0aW9uSWR9YDtcbiAgICBjb25zdCBwZWVyaW5nQ29ubmVjdGlvblJlcXVlc3QgPSBuZXcgZWMyLkNmblZQQ1BlZXJpbmdDb25uZWN0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIGNvbnN0cnVjdElkKHBlZXJQYWlySWQpLFxuICAgICAge1xuICAgICAgICBwZWVyVnBjSWQ6IHBlZXIudnBjSWQsXG4gICAgICAgIHZwY0lkOiB0aGlzLnZwYy52cGNJZFxuICAgICAgfVxuICAgICk7XG4gICAgdGhpcy5hZGRQZWVyaW5nUm91dGVzKHBlZXJpbmdDb25uZWN0aW9uUmVxdWVzdC5yZWYsIHBlZXIuY2lkckJsb2NrLCBjb25uZWN0aW9uSWQpO1xuICAgIG5ldyBWcGNQZWVyRG5zUmVzb2x1dGlvbih0aGlzLCBjb25zdHJ1Y3RJZChgcmVxdWVzdGVyLWRucy1yZXNvbHV0aW9uLSR7Y29ubmVjdGlvbklkfWApLCB7XG4gICAgICBwZWVyaW5nQ29ubmVjdGlvbklkOiBwZWVyaW5nQ29ubmVjdGlvblJlcXVlc3QucmVmLFxuICAgICAgdnBjQXJuOiB0aGlzLnZwYy52cGNBcm4sXG4gICAgICBhY2NvdW50SWQ6IHRoaXMuYWNjb3VudElkLFxuICAgICAgcmVnaW9uOiB0aGlzLnJlZ2lvbixcbiAgICAgIGlzUmVxdWVzdGVyOiB0cnVlXG4gICAgfSk7XG4gICAgcmV0dXJuIHBlZXJpbmdDb25uZWN0aW9uUmVxdWVzdDtcbiAgfVxuXG4gIHB1YmxpYyBhY2NlcHRFeHRlcm5hbFBlZXJpbmdDb25uZWN0aW9uIChwZWVyOiBFeHRlcm5hbFZwY1BlZXIsIHBlZXJpbmdDb25uZWN0aW9uSWQ6IHN0cmluZywgY29ubmVjdGlvbklkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB7XG4gICAgICBhY2NvdW50SWQgPSB0aGlzLmFjY291bnRJZCxcbiAgICAgIHJlZ2lvbiA9IHRoaXMucmVnaW9uLFxuICAgICAgdnBjSWRcbiAgICB9ID0gcGVlcjtcblxuICAgIGNvbnN0IGV4dGVybmFsVnBjQXJuID0gYGFybjphd3M6ZWMyOiR7cmVnaW9ufToke2FjY291bnRJZH06dnBjLyR7dnBjSWR9YDtcblxuICAgIG5ldyBWcGNQZWVyaW5nUmVxdWVzdEFjY2VwdGVyKHRoaXMsIGNvbnN0cnVjdElkKCdQZWVyaW5nUmVxdWVzdEFjY2VwdGVyJywgY29ubmVjdGlvbklkKSwge1xuICAgICAgdnBjQXJuOiBleHRlcm5hbFZwY0FybixcbiAgICAgIHBlZXJpbmdDb25uZWN0aW9uSWQsXG4gICAgICBhY2NvdW50SWQsXG4gICAgICByZWdpb25cbiAgICB9KTtcbiAgICBuZXcgVnBjUGVlcmluZ1JvdXRlcyh0aGlzLCBjb25zdHJ1Y3RJZCgnRXh0ZXJuYWxWcGNQZWVyaW5nUm91dGVzJywgY29ubmVjdGlvbklkKSwge1xuICAgICAgdnBjSWQ6IHBlZXIudnBjSWQsXG4gICAgICBwZWVyaW5nQ29ubmVjdGlvbklkLFxuICAgICAgZGVzdGluYXRpb25DaWRyQmxvY2s6IHRoaXMuY2lkckJsb2NrLFxuICAgICAgYWNjb3VudElkLFxuICAgICAgcmVnaW9uLFxuICAgICAgdW5pcXVlSWQ6IHJhbmRvbVVVSUQoKVxuICAgIH0pO1xuICAgIG5ldyBWcGNQZWVyRG5zUmVzb2x1dGlvbih0aGlzLCBjb25zdHJ1Y3RJZChgYWNjZXB0ZXItZG5zLXJlc29sdXRpb24tJHtjb25uZWN0aW9uSWR9YCksIHtcbiAgICAgIHBlZXJpbmdDb25uZWN0aW9uSWQsXG4gICAgICB2cGNBcm46IGV4dGVybmFsVnBjQXJuLFxuICAgICAgYWNjb3VudElkLFxuICAgICAgcmVnaW9uLFxuICAgICAgaXNBY2NlcHRlcjogdHJ1ZVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFkZFBlZXJpbmdSb3V0ZXMgKHBlZXJpbmdDb25uZWN0aW9uSWQ6IHN0cmluZywgZGVzdGluYXRpb25DaWRyQmxvY2s6IHN0cmluZywgY29ubmVjdGlvbklkOiBzdHJpbmcpIHtcbiAgICB0aGlzLnZwYy5wdWJsaWNTdWJuZXRzLmZvckVhY2goKHBzLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgeyByb3V0ZVRhYmxlIH0gPSBwcyBhcyBlYzIuU3VibmV0O1xuICAgICAgbmV3IGVjMi5DZm5Sb3V0ZSh0aGlzLCBjb25zdHJ1Y3RJZChgUHVibGljUGVlcmluZ1JvdXRlJHtpbmRleH0tJHtjb25uZWN0aW9uSWR9YCksIHtcbiAgICAgICAgcm91dGVUYWJsZUlkOiByb3V0ZVRhYmxlLnJvdXRlVGFibGVJZCxcbiAgICAgICAgZGVzdGluYXRpb25DaWRyQmxvY2ssXG4gICAgICAgIHZwY1BlZXJpbmdDb25uZWN0aW9uSWQ6IHBlZXJpbmdDb25uZWN0aW9uSWRcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuaW50ZXJuZXRBY2Nlc3MpIHtcbiAgICAgIHRoaXMudnBjLnByaXZhdGVTdWJuZXRzLmZvckVhY2goKHBzLCBpbmRleCkgPT4ge1xuICAgICAgICBjb25zdCB7IHJvdXRlVGFibGUgfSA9IHBzIGFzIGVjMi5TdWJuZXQ7XG4gICAgICAgIG5ldyBlYzIuQ2ZuUm91dGUodGhpcywgY29uc3RydWN0SWQoYFByaXZhdGVQZWVyaW5nUm91dGUke2luZGV4fS0ke2Nvbm5lY3Rpb25JZH1gKSwge1xuICAgICAgICAgIHJvdXRlVGFibGVJZDogcm91dGVUYWJsZS5yb3V0ZVRhYmxlSWQsXG4gICAgICAgICAgZGVzdGluYXRpb25DaWRyQmxvY2ssXG4gICAgICAgICAgdnBjUGVlcmluZ0Nvbm5lY3Rpb25JZDogcGVlcmluZ0Nvbm5lY3Rpb25JZFxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHRoaXMudnBjLmlzb2xhdGVkU3VibmV0cy5mb3JFYWNoKChwcywgaW5kZXgpID0+IHtcbiAgICAgIGNvbnN0IHsgcm91dGVUYWJsZSB9ID0gcHMgYXMgZWMyLlN1Ym5ldDtcbiAgICAgIG5ldyBlYzIuQ2ZuUm91dGUodGhpcywgY29uc3RydWN0SWQoYElzb2xhdGVkUGVlcmluZ1JvdXRlJHtpbmRleH0tJHtjb25uZWN0aW9uSWR9YCksIHtcbiAgICAgICAgcm91dGVUYWJsZUlkOiByb3V0ZVRhYmxlLnJvdXRlVGFibGVJZCxcbiAgICAgICAgZGVzdGluYXRpb25DaWRyQmxvY2ssXG4gICAgICAgIHZwY1BlZXJpbmdDb25uZWN0aW9uSWQ6IHBlZXJpbmdDb25uZWN0aW9uSWRcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldCB2cGMgKCk6IGVjMi5JVnBjIHtcbiAgICByZXR1cm4gdGhpcy5fdnBjO1xuICB9XG5cbiAgcHVibGljIGdldCBjaWRyQmxvY2sgKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX2NpZHJCbG9jaztcbiAgfVxufSJdfQ==